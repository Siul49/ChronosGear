# Phase 4: 스토리/연출

> 기간: 4주 | 대화 시스템, 컷신, 분기 구현

---

## 목표
- 대화 시스템 구현
- 선택지 및 분기 시스템
- 컷신 및 연출
- 엔딩 분기 로직

---

## Week 1-2: 대화 시스템

### DialogueData.cs (ScriptableObject)

```csharp
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "NewDialogue", menuName = "ChronosGear/DialogueData")]
public class DialogueData : ScriptableObject
{
    public string dialogueId;
    public List<DialogueLine> lines;
    public List<DialogueChoice> choices;
}

[System.Serializable]
public class DialogueLine
{
    public string speakerId;
    public string speakerName;
    public Sprite portrait;
    public PortraitPosition position;
    
    [TextArea(3, 5)]
    public string text;
    
    public DialogueEvent onLineStart;
    public DialogueEvent onLineEnd;
}

[System.Serializable]
public class DialogueChoice
{
    public string choiceText;
    public string nextDialogueId;
    public string flagToSet;
    public bool flagValue;
    
    public ChoiceCondition condition;
}

[System.Serializable]
public class ChoiceCondition
{
    public string requiredFlag;
    public bool requiredValue;
}

public enum PortraitPosition { Left, Right, Center }

[System.Serializable]
public class DialogueEvent
{
    public EventType type;
    public string parameter;
}

public enum EventType { None, PlaySound, CameraShake, FadeToBlack, SetFlag }
```

---

### DialogueManager.cs

```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections;

public class DialogueManager : MonoBehaviour
{
    public static DialogueManager Instance { get; private set; }
    
    [Header("UI References")]
    [SerializeField] private GameObject dialoguePanel;
    [SerializeField] private TextMeshProUGUI speakerNameText;
    [SerializeField] private TextMeshProUGUI dialogueText;
    [SerializeField] private Image portraitLeft;
    [SerializeField] private Image portraitRight;
    
    [Header("Choice UI")]
    [SerializeField] private GameObject choicePanel;
    [SerializeField] private Transform choiceContainer;
    [SerializeField] private GameObject choiceButtonPrefab;
    
    [Header("Settings")]
    [SerializeField] private float textSpeed = 0.05f;
    
    private DialogueData _currentDialogue;
    private int _currentLineIndex;
    private bool _isTyping;
    private bool _skipTyping;
    
    private void Awake()
    {
        Instance = this;
        dialoguePanel.SetActive(false);
    }
    
    public void StartDialogue(DialogueData dialogue)
    {
        _currentDialogue = dialogue;
        _currentLineIndex = 0;
        
        dialoguePanel.SetActive(true);
        GameManager.Instance.CurrentState = GameState.Dialogue;
        
        ShowLine(_currentDialogue.lines[0]);
    }
    
    private void ShowLine(DialogueLine line)
    {
        // 화자 이름
        speakerNameText.text = line.speakerName;
        
        // 초상화
        UpdatePortrait(line);
        
        // 이벤트 실행
        ExecuteEvent(line.onLineStart);
        
        // 텍스트 타이핑
        StartCoroutine(TypeText(line.text));
    }
    
    private IEnumerator TypeText(string text)
    {
        _isTyping = true;
        dialogueText.text = "";
        
        foreach (char c in text)
        {
            if (_skipTyping)
            {
                dialogueText.text = text;
                break;
            }
            
            dialogueText.text += c;
            yield return new WaitForSeconds(textSpeed);
        }
        
        _isTyping = false;
        _skipTyping = false;
    }
    
    public void OnContinue()
    {
        if (_isTyping)
        {
            _skipTyping = true;
            return;
        }
        
        _currentLineIndex++;
        
        if (_currentLineIndex < _currentDialogue.lines.Count)
        {
            ShowLine(_currentDialogue.lines[_currentLineIndex]);
        }
        else if (_currentDialogue.choices.Count > 0)
        {
            ShowChoices();
        }
        else
        {
            EndDialogue();
        }
    }
    
    private void ShowChoices()
    {
        choicePanel.SetActive(true);
        
        // 기존 버튼 제거
        foreach (Transform child in choiceContainer)
            Destroy(child.gameObject);
        
        // 선택지 버튼 생성
        foreach (var choice in _currentDialogue.choices)
        {
            if (!CheckCondition(choice.condition)) continue;
            
            var button = Instantiate(choiceButtonPrefab, choiceContainer);
            button.GetComponentInChildren<TextMeshProUGUI>().text = choice.choiceText;
            button.GetComponent<Button>().onClick.AddListener(() => OnChoiceSelected(choice));
        }
    }
    
    private void OnChoiceSelected(DialogueChoice choice)
    {
        choicePanel.SetActive(false);
        
        // 플래그 설정
        if (!string.IsNullOrEmpty(choice.flagToSet))
        {
            StoryFlagManager.Instance.SetFlag(choice.flagToSet, choice.flagValue);
        }
        
        // 다음 대화로
        if (!string.IsNullOrEmpty(choice.nextDialogueId))
        {
            var nextDialogue = Resources.Load<DialogueData>($"Dialogues/{choice.nextDialogueId}");
            StartDialogue(nextDialogue);
        }
        else
        {
            EndDialogue();
        }
    }
    
    private void EndDialogue()
    {
        dialoguePanel.SetActive(false);
        GameManager.Instance.CurrentState = GameState.Playing;
        
        EventBus.Publish(new OnDialogueEnded { dialogueId = _currentDialogue.dialogueId });
    }
    
    private void UpdatePortrait(DialogueLine line)
    {
        portraitLeft.gameObject.SetActive(line.position == PortraitPosition.Left);
        portraitRight.gameObject.SetActive(line.position == PortraitPosition.Right);
        
        if (line.position == PortraitPosition.Left)
            portraitLeft.sprite = line.portrait;
        else
            portraitRight.sprite = line.portrait;
    }
    
    private void ExecuteEvent(DialogueEvent evt)
    {
        switch (evt.type)
        {
            case EventType.PlaySound:
                AudioManager.Instance.PlaySFX(evt.parameter);
                break;
            case EventType.CameraShake:
                CameraManager.Instance.Shake(float.Parse(evt.parameter), 0.3f);
                break;
            case EventType.FadeToBlack:
                // 페이드 처리
                break;
            case EventType.SetFlag:
                StoryFlagManager.Instance.SetFlag(evt.parameter, true);
                break;
        }
    }
    
    private bool CheckCondition(ChoiceCondition condition)
    {
        if (string.IsNullOrEmpty(condition.requiredFlag)) return true;
        return StoryFlagManager.Instance.GetFlag(condition.requiredFlag) == condition.requiredValue;
    }
}

public struct OnDialogueEnded { public string dialogueId; }
```

---

### StoryFlagManager.cs

```csharp
using System.Collections.Generic;
using UnityEngine;

public class StoryFlagManager : MonoBehaviour
{
    public static StoryFlagManager Instance { get; private set; }
    
    private Dictionary<string, bool> _flags = new();
    
    // 엔딩 관련 플래그 (05_endings.md 참조)
    public const string FLAG_HELPED_RAY = "helped_ray";
    public const string FLAG_HELPED_VELO = "helped_velo";
    public const string FLAG_HELPED_MORA = "helped_mora";
    public const string FLAG_LEFT_RAY = "left_ray_alone";
    public const string FLAG_LEFT_VELO = "left_velo_alone";
    public const string FLAG_LEFT_MORA = "left_mora_alone";
    public const string FLAG_ALL_SHARDS = "collected_all_shards";
    public const string FLAG_MORA_MERCY = "showed_mercy_to_mora";
    
    private void Awake()
    {
        Instance = this;
    }
    
    public void SetFlag(string flag, bool value)
    {
        _flags[flag] = value;
        Debug.Log($"Flag set: {flag} = {value}");
    }
    
    public bool GetFlag(string flag)
    {
        return _flags.TryGetValue(flag, out bool value) && value;
    }
    
    public void SaveFlags(SaveData data)
    {
        data.storyFlags = new Dictionary<string, bool>(_flags);
    }
    
    public void LoadFlags(SaveData data)
    {
        _flags = new Dictionary<string, bool>(data.storyFlags);
    }
}
```

---

## Week 3-4: 연출/분기

### CutsceneController.cs (Timeline 연동)

```csharp
using UnityEngine;
using UnityEngine.Playables;
using UnityEngine.Timeline;

public class CutsceneController : MonoBehaviour
{
    [SerializeField] private PlayableDirector director;
    
    private System.Action _onComplete;
    
    public void PlayCutscene(TimelineAsset timeline, System.Action onComplete = null)
    {
        _onComplete = onComplete;
        
        GameManager.Instance.CurrentState = GameState.Cutscene;
        
        director.playableAsset = timeline;
        director.Play();
        
        director.stopped += OnCutsceneEnd;
    }
    
    private void OnCutsceneEnd(PlayableDirector pd)
    {
        director.stopped -= OnCutsceneEnd;
        GameManager.Instance.CurrentState = GameState.Playing;
        
        _onComplete?.Invoke();
    }
    
    public void SkipCutscene()
    {
        director.time = director.duration;
        director.Evaluate();
        director.Stop();
    }
}
```

---

### EndingManager.cs

```csharp
using UnityEngine;

public class EndingManager : MonoBehaviour
{
    public static EndingManager Instance { get; private set; }
    
    private void Awake()
    {
        Instance = this;
    }
    
    // 05_endings.md 및 07_hidden_clockmaker.md 참조
    public EndingType DetermineEnding(FinalChoice choice)
    {
        var flags = StoryFlagManager.Instance;
        var stats = GameManager.Instance.Player.Stats;
        
        // 히든 엔딩 조건 체크 (07_hidden_clockmaker.md)
        if (CheckHiddenConditions())
        {
            return EndingType.Hidden;
        }
        
        // 최종 선택에 따른 분기
        switch (choice)
        {
            case FinalChoice.DropWatch:
                return EndingType.BadA; // 순환의 고리
                
            case FinalChoice.DoNothing:
                return EndingType.BadB; // 영원한 정지
                
            case FinalChoice.DestroyGear:
                return EndingType.True; // 흐르는 시간
        }
        
        return EndingType.BadA;
    }
    
    private bool CheckHiddenConditions()
    {
        var flags = StoryFlagManager.Instance;
        var stats = GameManager.Instance.Player.Stats;
        
        // 1. 모든 시간 파편 수집
        bool allShards = flags.GetFlag(StoryFlagManager.FLAG_ALL_SHARDS);
        
        // 2. 모든 친구 과거에 개입 안함
        bool leftRay = flags.GetFlag(StoryFlagManager.FLAG_LEFT_RAY);
        bool leftVelo = flags.GetFlag(StoryFlagManager.FLAG_LEFT_VELO);
        bool leftMora = flags.GetFlag(StoryFlagManager.FLAG_LEFT_MORA);
        bool noIntervention = leftRay && leftVelo && leftMora;
        
        // 3. 노화 80% 이상
        bool oldEnough = stats.AgingGauge >= 80f;
        
        // 4. 모라에게 자비 표시
        bool showedMercy = flags.GetFlag(StoryFlagManager.FLAG_MORA_MERCY);
        
        return allShards && noIntervention && oldEnough && showedMercy;
    }
    
    public void TriggerEnding(EndingType ending)
    {
        switch (ending)
        {
            case EndingType.BadA:
                SceneLoader.Instance.LoadScene("Ending_BadA");
                break;
            case EndingType.BadB:
                SceneLoader.Instance.LoadScene("Ending_BadB");
                break;
            case EndingType.True:
                SceneLoader.Instance.LoadScene("Ending_True");
                break;
            case EndingType.Hidden:
                TriggerClockmakerScene();
                break;
        }
    }
    
    private void TriggerClockmakerScene()
    {
        // 시계공 등장 연출
        Time.timeScale = 0f;
        
        // 특수 씬 로드
        SceneLoader.Instance.LoadScene("Ending_Hidden_Clockmaker");
    }
}

public enum EndingType { BadA, BadB, True, Hidden }
public enum FinalChoice { DropWatch, DoNothing, DestroyGear, BecomeClockmaker }
```

---

### Chapter4_FinalChoice.cs

```csharp
using UnityEngine;

public class Chapter4_FinalChoice : MonoBehaviour
{
    [Header("UI")]
    [SerializeField] private GameObject choiceUI;
    [SerializeField] private GameObject clockmakerChoice; // 히든 조건 충족 시만 표시
    
    private void Start()
    {
        // 히든 조건 체크
        bool hiddenUnlocked = EndingManager.Instance.CheckHiddenConditions();
        clockmakerChoice.SetActive(hiddenUnlocked);
        
        ShowFinalChoice();
    }
    
    public void ShowFinalChoice()
    {
        GameManager.Instance.CurrentState = GameState.Dialogue;
        choiceUI.SetActive(true);
    }
    
    public void OnChoice_DropWatch()
    {
        EndingManager.Instance.TriggerEnding(EndingType.BadA);
    }
    
    public void OnChoice_DoNothing()
    {
        EndingManager.Instance.TriggerEnding(EndingType.BadB);
    }
    
    public void OnChoice_DestroyGear()
    {
        // 히든 조건 체크
        if (EndingManager.Instance.CheckHiddenConditions())
        {
            // 시계공 등장 → 추가 선택
            TriggerClockmakerAppearance();
        }
        else
        {
            EndingManager.Instance.TriggerEnding(EndingType.True);
        }
    }
    
    public void OnChoice_BecomeClockmaker()
    {
        EndingManager.Instance.TriggerEnding(EndingType.Hidden);
    }
    
    private void TriggerClockmakerAppearance()
    {
        // 시계공 등장 컷신
        var cutscene = Resources.Load<TimelineAsset>("Cutscenes/ClockmakerAppears");
        GetComponent<CutsceneController>().PlayCutscene(cutscene, () =>
        {
            // 컷신 후 추가 선택지 표시
            clockmakerChoice.SetActive(true);
        });
    }
}
```

---

## Phase 4 체크리스트

### 대화 시스템
- [ ] DialogueData SO
- [ ] DialogueManager.cs
- [ ] 대화 UI
- [ ] 텍스트 타이핑
- [ ] 초상화 시스템

### 선택지/분기
- [ ] 선택지 UI
- [ ] StoryFlagManager.cs
- [ ] 조건부 선택지

### 연출
- [ ] CutsceneController.cs
- [ ] Timeline 컷신
- [ ] 이벤트 연동

### 엔딩
- [ ] EndingManager.cs
- [ ] 4종 엔딩 로직
- [ ] 히든 조건 체크
- [ ] 시계공 등장 연출

---

## 다음 단계
Phase 4 완료 후 [Phase 5: 폴리싱/QA](./18_phase5_polish.md)으로 진행
