# Phase 5: 폴리싱/QA

> 기간: 4-6주 | UI, 사운드, 밸런싱, 최적화

---

## 목표
- HUD 및 메뉴 UI 구현
- 오디오 시스템 구현
- 게임 밸런싱
- 성능 최적화 및 빌드

---

## Week 1-2: UI/UX

### HUDController.cs

```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class HUDController : MonoBehaviour
{
    [Header("HP/TP Bars - from 12_ui_sound_guide.md")]
    [SerializeField] private Slider hpBar;
    [SerializeField] private Slider tpBar;
    [SerializeField] private TextMeshProUGUI hpText;
    [SerializeField] private TextMeshProUGUI tpText;
    
    [Header("Aging Gauge")]
    [SerializeField] private Slider agingBar;
    [SerializeField] private Image agingFill;
    [SerializeField] private Color[] agingColors; // Young, Adult, Middle, Old
    
    [Header("Skill Icons")]
    [SerializeField] private SkillSlotUI[] skillSlots;
    
    [Header("Quick Slots")]
    [SerializeField] private QuickSlotUI[] quickSlots;
    
    private PlayerStats _playerStats;
    
    private void Start()
    {
        _playerStats = GameManager.Instance.Player.GetComponent<PlayerStats>();
        
        // 이벤트 구독
        EventBus.Subscribe<OnPlayerDamaged>(OnPlayerDamaged);
        EventBus.Subscribe<OnAgingChanged>(OnAgingChanged);
    }
    
    private void Update()
    {
        UpdateBars();
    }
    
    private void UpdateBars()
    {
        // HP
        hpBar.value = (float)_playerStats.CurrentHP / _playerStats.MaxHP;
        hpText.text = $"{_playerStats.CurrentHP}/{_playerStats.MaxHP}";
        
        // TP
        tpBar.value = (float)_playerStats.CurrentTP / _playerStats.MaxTP;
        tpText.text = $"{_playerStats.CurrentTP}/{_playerStats.MaxTP}";
        
        // 노화
        agingBar.value = _playerStats.AgingGauge / 100f;
        agingFill.color = GetAgingColor(_playerStats.CurrentStage);
    }
    
    private void OnPlayerDamaged(OnPlayerDamaged evt)
    {
        // HP 바 흔들림 연출
        StartCoroutine(ShakeUI(hpBar.transform));
        
        // 위험 상태 (30% 이하)
        if ((float)evt.CurrentHP / _playerStats.MaxHP <= 0.3f)
        {
            hpBar.GetComponent<Animator>().SetBool("Danger", true);
        }
    }
    
    private void OnAgingChanged(OnAgingChanged evt)
    {
        // 단계 변경 시 연출
        var oldStage = GetStage(evt.OldValue);
        var newStage = GetStage(evt.NewValue);
        
        if (oldStage != newStage)
        {
            ShowAgingNotification(newStage);
        }
    }
    
    private Color GetAgingColor(AgingStage stage)
    {
        return stage switch
        {
            AgingStage.Young => agingColors[0],  // #2ecc71
            AgingStage.Adult => agingColors[1],  // #f1c40f
            AgingStage.Middle => agingColors[2], // #e67e22
            AgingStage.Old => agingColors[3],    // #9b59b6
            _ => Color.white
        };
    }
    
    private AgingStage GetStage(float value)
    {
        if (value < 25f) return AgingStage.Young;
        if (value < 50f) return AgingStage.Adult;
        if (value < 75f) return AgingStage.Middle;
        return AgingStage.Old;
    }
    
    private void ShowAgingNotification(AgingStage stage)
    {
        UIManager.Instance.ShowNotification($"노화 단계: {stage}");
    }
    
    private System.Collections.IEnumerator ShakeUI(Transform target)
    {
        Vector3 originalPos = target.localPosition;
        float elapsed = 0f;
        float duration = 0.2f;
        
        while (elapsed < duration)
        {
            target.localPosition = originalPos + (Vector3)Random.insideUnitCircle * 5f;
            elapsed += Time.deltaTime;
            yield return null;
        }
        
        target.localPosition = originalPos;
    }
}

[System.Serializable]
public class SkillSlotUI
{
    public Image icon;
    public Image cooldownOverlay;
    public TextMeshProUGUI keyText;
}

[System.Serializable]
public class QuickSlotUI
{
    public Image icon;
    public TextMeshProUGUI countText;
}
```

---

### MenuController.cs

```csharp
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;

public class MenuController : MonoBehaviour
{
    [Header("Panels")]
    [SerializeField] private GameObject pausePanel;
    [SerializeField] private GameObject inventoryPanel;
    [SerializeField] private GameObject skillPanel;
    [SerializeField] private GameObject mapPanel;
    [SerializeField] private GameObject settingsPanel;
    
    [Header("First Selected")]
    [SerializeField] private GameObject pauseFirstButton;
    
    private GameObject _currentPanel;
    
    private void Update()
    {
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            TogglePause();
        }
    }
    
    public void TogglePause()
    {
        if (_currentPanel == pausePanel)
        {
            CloseMenu();
        }
        else if (_currentPanel == null)
        {
            OpenMenu(pausePanel, pauseFirstButton);
        }
        else
        {
            // 서브메뉴에서 ESC = 메인 일시정지로
            OpenMenu(pausePanel, pauseFirstButton);
        }
    }
    
    public void OpenMenu(GameObject panel, GameObject firstSelected = null)
    {
        // 이전 패널 닫기
        if (_currentPanel != null)
            _currentPanel.SetActive(false);
        
        // 새 패널 열기
        panel.SetActive(true);
        _currentPanel = panel;
        
        // 게임 일시정지
        GameManager.Instance.PauseGame();
        
        // 네비게이션 설정
        if (firstSelected != null)
            EventSystem.current.SetSelectedGameObject(firstSelected);
    }
    
    public void CloseMenu()
    {
        if (_currentPanel != null)
        {
            _currentPanel.SetActive(false);
            _currentPanel = null;
        }
        
        GameManager.Instance.ResumeGame();
    }
    
    // 버튼 콜백
    public void OnClickResume() => CloseMenu();
    public void OnClickInventory() => OpenMenu(inventoryPanel);
    public void OnClickSkills() => OpenMenu(skillPanel);
    public void OnClickMap() => OpenMenu(mapPanel);
    public void OnClickSettings() => OpenMenu(settingsPanel);
    
    public void OnClickMainMenu()
    {
        Time.timeScale = 1f;
        SceneLoader.Instance.LoadScene("MainMenu");
    }
}
```

---

## Week 3-4: 사운드/밸런싱

### AudioManager.cs

```csharp
using UnityEngine;
using System.Collections.Generic;

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }
    
    [Header("Sources")]
    [SerializeField] private AudioSource bgmSource;
    [SerializeField] private AudioSource sfxSource;
    
    [Header("Audio Data - from 12_ui_sound_guide.md")]
    [SerializeField] private AudioClipData[] bgmClips;
    [SerializeField] private AudioClipData[] sfxClips;
    
    private Dictionary<string, AudioClip> _bgmDict = new();
    private Dictionary<string, AudioClip> _sfxDict = new();
    
    private float _masterVolume = 0.8f;
    private float _bgmVolume = 0.7f;
    private float _sfxVolume = 1f;
    
    private void Awake()
    {
        Instance = this;
        DontDestroyOnLoad(gameObject);
        
        // 딕셔너리 초기화
        foreach (var clip in bgmClips)
            _bgmDict[clip.id] = clip.clip;
        foreach (var clip in sfxClips)
            _sfxDict[clip.id] = clip.clip;
    }
    
    public void PlayBGM(string id, float fadeIn = 1f)
    {
        if (!_bgmDict.TryGetValue(id, out var clip)) return;
        
        StartCoroutine(FadeBGM(clip, fadeIn));
    }
    
    private System.Collections.IEnumerator FadeBGM(AudioClip newClip, float duration)
    {
        // 페이드 아웃
        float startVolume = bgmSource.volume;
        float elapsed = 0f;
        
        while (elapsed < duration / 2)
        {
            bgmSource.volume = Mathf.Lerp(startVolume, 0, elapsed / (duration / 2));
            elapsed += Time.deltaTime;
            yield return null;
        }
        
        // 클립 변경
        bgmSource.clip = newClip;
        bgmSource.Play();
        
        // 페이드 인
        elapsed = 0f;
        float targetVolume = _masterVolume * _bgmVolume;
        
        while (elapsed < duration / 2)
        {
            bgmSource.volume = Mathf.Lerp(0, targetVolume, elapsed / (duration / 2));
            elapsed += Time.deltaTime;
            yield return null;
        }
        
        bgmSource.volume = targetVolume;
    }
    
    public void PlaySFX(string id)
    {
        if (!_sfxDict.TryGetValue(id, out var clip)) return;
        
        sfxSource.PlayOneShot(clip, _masterVolume * _sfxVolume);
    }
    
    public void SetVolume(VolumeType type, float value)
    {
        switch (type)
        {
            case VolumeType.Master:
                _masterVolume = value;
                break;
            case VolumeType.BGM:
                _bgmVolume = value;
                bgmSource.volume = _masterVolume * _bgmVolume;
                break;
            case VolumeType.SFX:
                _sfxVolume = value;
                break;
        }
        
        PlayerPrefs.SetFloat($"Volume_{type}", value);
    }
}

[System.Serializable]
public class AudioClipData
{
    public string id;
    public AudioClip clip;
}

public enum VolumeType { Master, BGM, SFX }
```

---

### BalanceConfig.cs

```csharp
using UnityEngine;

[CreateAssetMenu(fileName = "BalanceConfig", menuName = "ChronosGear/BalanceConfig")]
public class BalanceConfig : ScriptableObject
{
    [Header("Difficulty Modifiers - from 08_balance_sheet.md")]
    public DifficultySettings[] difficulties;
    
    [Header("Current")]
    public int currentDifficultyIndex = 1; // Normal
    
    public DifficultySettings Current => difficulties[currentDifficultyIndex];
}

[System.Serializable]
public class DifficultySettings
{
    public string name;
    public float enemyHPMultiplier = 1f;
    public float enemyATKMultiplier = 1f;
    public float justWindowMultiplier = 1f;
    public float expMultiplier = 1f;
    
    // 프리셋 (08_balance_sheet.md)
    public static DifficultySettings Story => new()
    {
        name = "스토리",
        enemyHPMultiplier = 0.5f,
        enemyATKMultiplier = 0.5f,
        justWindowMultiplier = 1.67f,
        expMultiplier = 0.5f
    };
    
    public static DifficultySettings Normal => new()
    {
        name = "일반",
        enemyHPMultiplier = 1f,
        enemyATKMultiplier = 1f,
        justWindowMultiplier = 1f,
        expMultiplier = 1f
    };
    
    public static DifficultySettings Hard => new()
    {
        name = "도전",
        enemyHPMultiplier = 1.5f,
        enemyATKMultiplier = 1.5f,
        justWindowMultiplier = 0.67f,
        expMultiplier = 1.5f
    };
    
    public static DifficultySettings Master => new()
    {
        name = "시계공",
        enemyHPMultiplier = 2f,
        enemyATKMultiplier = 2f,
        justWindowMultiplier = 0.33f,
        expMultiplier = 2f
    };
}
```

---

## Week 5-6: 최적화/빌드

### Optimization Checklist

#### 프로파일링
```
1. Unity Profiler 실행
2. CPU 병목 확인
3. GPU 병목 확인
4. 메모리 사용량 확인
```

#### 일반 최적화
- [ ] Object Pooling 적용 (완료됨 - Phase 0)
- [ ] 불필요한 Update() 제거
- [ ] GetComponent 캐싱
- [ ] String 연산 최소화
- [ ] Distance 대신 sqrMagnitude 사용

#### 렌더링 최적화
- [ ] 스프라이트 아틀라스 생성
- [ ] 배칭 최적화
- [ ] 카메라 Culling 설정
- [ ] 파티클 수 제한

#### 메모리 최적화
- [ ] 텍스처 압축
- [ ] 오디오 압축
- [ ] Resources 폴더 정리
- [ ] Addressables 도입 (선택)

---

### BuildManager.cs

```csharp
#if UNITY_EDITOR
using UnityEditor;
using UnityEditor.Build.Reporting;
using UnityEngine;

public class BuildManager
{
    private static string[] GetScenes()
    {
        return new[]
        {
            "Assets/_Project/Scenes/_Bootstrap.unity",
            "Assets/_Project/Scenes/MainMenu.unity",
            "Assets/_Project/Scenes/Prologue/Prologue_Attic.unity",
            // 모든 씬 추가
        };
    }
    
    [MenuItem("Build/Build Windows")]
    public static void BuildWindows()
    {
        var options = new BuildPlayerOptions
        {
            scenes = GetScenes(),
            locationPathName = "Builds/Windows/ChronosGear.exe",
            target = BuildTarget.StandaloneWindows64,
            options = BuildOptions.None
        };
        
        BuildPipeline.BuildPlayer(options);
    }
    
    [MenuItem("Build/Build Development")]
    public static void BuildDevelopment()
    {
        var options = new BuildPlayerOptions
        {
            scenes = GetScenes(),
            locationPathName = "Builds/Dev/ChronosGear.exe",
            target = BuildTarget.StandaloneWindows64,
            options = BuildOptions.Development | BuildOptions.AllowDebugging
        };
        
        BuildPipeline.BuildPlayer(options);
    }
}
#endif
```

---

### QA Checklist

#### 기능 테스트
- [ ] 모든 스킬 정상 작동
- [ ] 모든 적 AI 정상 작동
- [ ] 모든 보스 페이즈 전환
- [ ] 모든 엔딩 도달 가능
- [ ] 히든 엔딩 조건 확인
- [ ] 세이브/로드 정상

#### 밸런스 테스트
- [ ] 1장 보스 클리어 시간 (5-10분)
- [ ] 최종 보스 클리어 시간 (15-20분)
- [ ] 예상 강화 진행도 확인
- [ ] 난이도별 체감 확인

#### 버그 체크리스트
- [ ] 벽 관통 체크
- [ ] 무한 TP 버그
- [ ] 노화 오버플로우
- [ ] UI 겹침
- [ ] 오디오 끊김

---

## Phase 5 체크리스트

### UI
- [ ] HUD 구현
- [ ] 일시정지 메뉴
- [ ] 인벤토리 UI
- [ ] 스킬 트리 UI
- [ ] 지도 UI
- [ ] 설정 UI

### 사운드
- [ ] AudioManager.cs
- [ ] BGM 연동
- [ ] SFX 연동
- [ ] 볼륨 설정

### 밸런싱
- [ ] 난이도 시스템
- [ ] 밸런스 테스트
- [ ] 수치 조정

### 최적화
- [ ] 프로파일링
- [ ] 오브젝트 풀링
- [ ] 스프라이트 아틀라스
- [ ] 빌드 테스트

---

## 최종 체크리스트

- [ ] 모든 기능 정상 작동
- [ ] 모든 엔딩 확인
- [ ] 성능 목표 달성 (60fps)
- [ ] 빌드 성공
- [ ] 플레이 테스트 완료
